console.log("### App Framework ### Start: 0.0.2 Build 20190401"),function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):(t=t||self).BILIWS=o()}(this,function(){"use strict";var t="ws://broadcastlv.chat.bilibili.com:2244/sub";void 0!==window&&("https"===location.origin.match(/^(.+):\/\//)[1]&&(t="wss://broadcastlv.chat.bilibili.com:2245/sub"));var o=t,e=[{name:"Header Length",key:"headerLen",bytes:2,offset:4,value:16},{name:"Protocol Version",key:"ver",bytes:2,offset:6,value:1},{name:"Operation",key:"op",bytes:4,offset:8,value:1},{name:"Sequence Id",key:"seq",bytes:4,offset:12,value:1}];function n(t,o){void 0===t&&(t=2),void 0===o&&(o="");var e=function(t){for(var o,e=[],n=t.length,i=0;i<n;i++)(o=t.charCodeAt(i))>=65536&&o<=1114111?(e.push(o>>18&7|240),e.push(o>>12&63|128),e.push(o>>6&63|128),e.push(63&o|128)):o>=2048&&o<=65535?(e.push(o>>12&15|224),e.push(o>>6&63|128),e.push(63&o|128)):o>=128&&o<=2047?(e.push(o>>6&31|192),e.push(63&o|128)):e.push(255&o);return e}(o),n=new ArrayBuffer(e.length+16),i=new DataView(n);i.setUint32(0,e.length+16),i.setUint16(4,16),i.setUint16(6,1),i.setUint32(8,t),i.setUint32(12,1);for(var r=0;r<e.length;r++)i.setUint8(16+r,e[r]);return i}var i=function(t){this.roomid=t,this._docker=new WebSocket(o),this._methods=[]};i.prototype.init=function(){var t=this;console.log("新的socket正在初始化..."),this._docker.binaryType="arraybuffer",this._docker.onopen=function(o){var e=t._joinRoom(t.roomid);t._docker.send(e.buffer),t._sendBeat()},this._docker.onmessage=function(o){for(var n,i,r=new DataView(o.data),s=function(o){var s={};if(n=r.getUint32(o),i=r.getUint16(o+4),e.forEach(function(t){4===t.bytes?s[t.key]=r.getUint32(o+t.offset):2===t.bytes&&(s[t.key]=r.getUint16(o+t.offset))}),s.op&&5===s.op){s.body=[];for(var c=[],f=o+i;f<o+n;f++)c.push(r.getUint8(f));try{s.body=[];var h=JSON.parse(function(t){for(var o,e=t.slice(0),n=[[127],[31,63],[15,63,63],[7,63,63,63]],i="",r=0;r<e.length;r+=o){var s=e[r],a="";s>=240?o=4:s>=224?o=3:s>=192?o=2:s<128&&(o=1);for(var c=n[o-1],f=0;f<o;f++){var h=(e[r+f]&c[f]).toString(2),u=h.length;if(u>6){a=h;break}for(var d=0;d<6-u;d++)h="0"+h;a+=h}i+=String.fromCharCode(parseInt(a,2))}return i}(c));"DANMU_MSG"===h.cmd&&(console.log(h.info[2][1],":",h.info[1]),t._call({name:h.info[2][1],text:h.info[1]})),s.body.push(h)}catch(t){console.log(t)}}a=o+=n},a=0;a<r.byteLength;)s(a)},this._docker.onclose=function(t){console.log("旧的socket已经关闭...")}},i.prototype.addMethods=function(t){this._methods=t},i.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._docker.close()},i.prototype._call=function(){for(var t=[],o=arguments.length;o--;)t[o]=arguments[o];for(var e=0,n=this._methods.length;e<n;e++){var i=this._methods[e];"function"==typeof i&&i.apply(null,t)}},i.prototype._joinRoom=function(t,o){return void 0===t&&(t=282712),void 0===o&&(o=19176530),n(7,JSON.stringify({uid:o,roomid:t}))},i.prototype._sendBeat=function(){var t=this;this._timer=setInterval(function(){t._docker.send(n())},3e4)};var r=function(t){this.roomid=t,this.socket=new i(t)};return r.prototype._init=function(){this.socket.init()},r.prototype.$start=function(){return console.log("加入房间"+this.roomid),this._init(),this},r.prototype.$destroy=function(){this.socket.close(),this.socket=null,console.log("退出房间"+this.roomid),this.roomid=null},r.prototype.$subscribe=function(t){var o=Array.isArray(t)?t:[t];return this.socket.addMethods(o),this},r});
//# sourceMappingURL=index.js.map
