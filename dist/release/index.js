console.log("### App Framework ### Start: 0.0.1 Build 20190329"),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).BILIWS=e()}(this,function(){"use strict";var t="ws://broadcastlv.chat.bilibili.com:2244/sub";void 0!==window&&("https"===location.origin.match(/^(.+):\/\//)[1]&&(t="wss://broadcastlv.chat.bilibili.com:2245/sub"));var e=t,o=[{name:"Header Length",key:"headerLen",bytes:2,offset:4,value:16},{name:"Protocol Version",key:"ver",bytes:2,offset:6,value:1},{name:"Operation",key:"op",bytes:4,offset:8,value:1},{name:"Sequence Id",key:"seq",bytes:4,offset:12,value:1}];function n(t){for(var e,o=t.slice(0),n=[[127],[31,63],[15,63,63],[7,63,63,63]],i="",r=0;r<o.length;r+=e){var s=o[r],a="";s>=240?e=4:s>=224?e=3:s>=192?e=2:s<128&&(e=1);for(var c=n[e-1],f=0;f<e;f++){var h=(o[r+f]&c[f]).toString(2),u=h.length;if(u>6){a=h;break}for(var d=0;d<6-u;d++)h="0"+h;a+=h}i+=String.fromCharCode(parseInt(a,2))}return i}function i(t,e){void 0===t&&(t=2),void 0===e&&(e="");var o=function(t){for(var e,o=[],n=t.length,i=0;i<n;i++)(e=t.charCodeAt(i))>=65536&&e<=1114111?(o.push(e>>18&7|240),o.push(e>>12&63|128),o.push(e>>6&63|128),o.push(63&e|128)):e>=2048&&e<=65535?(o.push(e>>12&15|224),o.push(e>>6&63|128),o.push(63&e|128)):e>=128&&e<=2047?(o.push(e>>6&31|192),o.push(63&e|128)):o.push(255&e);return o}(e),n=new ArrayBuffer(o.length+16),i=new DataView(n);i.setUint32(0,o.length+16),i.setUint16(4,16),i.setUint16(6,1),i.setUint32(8,t),i.setUint32(12,1);for(var r=0;r<o.length;r++)i.setUint8(16+r,o[r]);return i}var r=function(t){this.roomid=t,this._docker=new WebSocket(e),this._methods=[]};r.prototype.init=function(){var t=this;console.log("新的socket正在初始化..."),this._docker.binaryType="arraybuffer",this._docker.onopen=function(e){var o=t._joinRoom(t.roomid);t._docker.send(o.buffer),t._sendBeat()},this._docker.onmessage=function(e){var i=new DataView(e.data),r={};if(r.packetLen=i.getUint32(0),o.forEach(function(t){4===t.bytes?r[t.key]=i.getUint32(t.offset):2===t.bytes&&(r[t.key]=i.getUint16(t.offset))}),r.op&&5===r.op){r.body=[];for(var s=r.packetLen,a=0;a<i.byteLength;a+=s){s=i.getUint32(a);for(var c=[],f=i.getUint16(a+4);f<s;f++)c.push(i.getUint8(f));try{var h=JSON.parse(n(c));"DANMU_MSG"===h.cmd&&(console.log(h.info[2][1],":",h.info[1]),t._call({name:h.info[2][1],text:h.info[1]})),r.body.push(h)}catch(t){}}}},this._docker.onclose=function(t){console.log("旧的socket已经关闭...")}},r.prototype.addMethods=function(t){this._methods=t},r.prototype.close=function(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._docker.close()},r.prototype._call=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var o=0,n=this._methods.length;o<n;o++){var i=this._methods[o];"function"==typeof i&&i.apply(null,t)}},r.prototype._joinRoom=function(t,e){return void 0===t&&(t=282712),void 0===e&&(e=19176530),i(7,JSON.stringify({uid:e,roomid:t}))},r.prototype._sendBeat=function(){var t=this;this._timer=setInterval(function(){t._docker.send(i())},3e3)};var s=function(t){this.roomid=t,this.socket=new r(t)};return s.prototype._init=function(){this.socket.init()},s.prototype.$start=function(){return console.log("加入房间"+this.roomid),this._init(),this},s.prototype.$destroy=function(){this.socket.close(),this.socket=null,console.log("退出房间"+this.roomid),this.roomid=null},s.prototype.$subscribe=function(t){var e=Array.isArray(t)?t:[t];return this.socket.addMethods(e),this},s});
//# sourceMappingURL=index.js.map
